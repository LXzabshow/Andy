<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andyçš„èƒŒåŒ…</title>
    <style>
        /* å¼•å…¥åƒç´ å­—ä½“ (å¦‚æœæœ‰çš„è¯ï¼Œæ²¡æœ‰åˆ™ç”¨é»˜è®¤) */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body { 
            background-color: #5d9ad3; /* MCçš„å¤©ç©ºè“ */
            font-family: 'VT323', 'Courier New', monospace; /* å°è¯•ä½¿ç”¨åƒç´ å­—ä½“ */
            text-align: center; 
            padding: 20px; 
            color: #333;
            overflow-x: hidden;
        }

        /* æ¨¡æ‹Ÿ MC çš„ç°è‰² GUI ç•Œé¢ */
        .card { 
            background-color: #c6c6c6; 
            border: 4px solid #373737;
            /* ç»å…¸çš„ MC è¾¹æ¡†å…‰å½±æ•ˆæœ */
            box-shadow: inset 4px 4px #ffffff, inset -4px -4px #555555, 10px 10px 0px rgba(0,0,0,0.2); 
            max-width: 90%;
            margin: 40px auto;
            padding: 30px 20px; 
            position: relative; 
            z-index: 10; 
        }
        
        h2 { 
            color: #3f3f3f; 
            margin: 0 0 20px 0; 
            font-size: 28px; 
            text-shadow: 2px 2px #fff;
            letter-spacing: 2px;
        }

        .icon-box {
            background: #8b8b8b;
            width: 100px;
            height: 100px;
            margin: 0 auto;
            border: 3px solid #373737;
            border-right-color: #fff;
            border-bottom-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .coin-icon { 
            font-size: 60px; 
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.3)); 
            transition: transform 0.2s;
        }
        
        .label { 
            color: #444; 
            font-size: 16px; 
            margin-top: 20px; 
            font-weight: bold;
        }

        .total { 
            font-size: 80px; 
            color: #fff; 
            font-weight: bold; 
            text-shadow: 4px 4px 0px #333; /* åƒç´ å­—ä½“æè¾¹æ„Ÿ */
            margin: 10px 0;
            font-family: 'Verdana', sans-serif; /* æ•°å­—ç”¨ç²—ä½“æ›´åƒæ¸¸æˆ */
        }
        
        /* MC é£æ ¼æŒ‰é’® */
        .btn-refresh { 
            margin-top: 20px; 
            background-color: #727272; 
            color: #fff; 
            border: 3px solid #000;
            /* æŒ‰é’®ç«‹ä½“æ„Ÿ */
            box-shadow: inset 3px 3px #aaa, inset -3px -3px #444;
            padding: 12px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            font-family: inherit;
            text-transform: uppercase;
        }
        .btn-refresh:active { 
            background-color: #555;
            box-shadow: inset 3px 3px #333, inset -3px -3px #888;
            transform: translateY(2px);
        }

        .message { 
            color: #333; 
            margin-top: 15px; 
            font-size: 14px; 
            min-height: 20px; 
            font-weight: bold;
        }

        /* å‡çº§åŠ¨ç”» */
        .celebrate { animation: bounce 0.5s infinite alternate; color: #55ff55 !important; text-shadow: 4px 4px 0px #004400 !important;}
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

        /* ç²’å­æ ·å¼ */
        .confetti { position: fixed; top: -50px; z-index: 99; animation: fall linear forwards; pointer-events: none; filter: drop-shadow(2px 2px 0 #000); }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body>

    <div class="card">
        <h2>Andyçš„èƒŒåŒ…</h2>
        
        <div class="icon-box">
            <div class="coin-icon" id="icon">ğŸ’</div>
        </div>

        <div class="label">å½“å‰é’»çŸ³æ•°é‡</div>
        
        <div id="totalDisplay" class="total">...</div>
        
        <div id="statusMsg" class="message"></div>

        <button class="btn-refresh" onclick="manualCheck()">åˆ·æ–°æœåŠ¡å™¨</button>
    </div>

    <script>
        // ==========================================
        const BIN_ID = '695f1cbed0ea881f405c1aab'; 
        const API_KEY = '$2a$10$pSEOl/63AtvEMUqQopzGeuhVgcRcfXSz5L8lyQdZZHZM66zdYKI0O'; 
        // ==========================================

        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const totalDisplay = document.getElementById('totalDisplay');
        const statusMsg = document.getElementById('statusMsg');
        const coinIcon = document.getElementById('icon');
        
        let lastCoins = null; 
        
        async function checkCloud(isManual = false) {
            // å¦‚æœæ˜¯æ‰‹åŠ¨ç‚¹å‡»ï¼Œæ‰æ˜¾ç¤ºæ–‡å­—ï¼Œå¦åˆ™ä¿æŒé™é»˜
            if(isManual) statusMsg.innerText = "æ­£åœ¨è¯»å–æœåŠ¡å™¨å­˜æ¡£...";
            
            try {
                let response = await fetch(BASE_URL + '/latest', {
                    headers: { 'X-Master-Key': API_KEY }
                });
                let data = await response.json();
                let cloudCoins = data.record.coins || 0;
                let usedIds = data.record.transactions || [];

                if (lastCoins === null) {
                    lastCoins = parseInt(localStorage.getItem('andy_last_seen_coins')) || cloudCoins;
                }

                // æ¸…ç©ºæç¤ºæ–‡å­—ï¼ˆé™¤éæœ‰æ–°æ¶ˆæ¯ï¼‰
                statusMsg.innerText = "";

                if (cloudCoins > lastCoins) {
                    let diff = cloudCoins - lastCoins;
                    showSuccessAnimation(diff); 
                } else if (cloudCoins < lastCoins) {
                    statusMsg.innerText = `ä½¿ç”¨äº† ${lastCoins - cloudCoins} é¢—é’»çŸ³`;
                } else {
                    if(isManual) statusMsg.innerText = "æ²¡æœ‰æ–°çš„æˆ˜åˆ©å“";
                    // 1ç§’åæ¶ˆå¤±ï¼Œä¿æŒç•Œé¢å¹²å‡€
                    setTimeout(() => { if(statusMsg.innerText === "æ²¡æœ‰æ–°çš„æˆ˜åˆ©å“") statusMsg.innerText = ""; }, 1500);
                }

                totalDisplay.innerText = cloudCoins;
                lastCoins = cloudCoins;
                localStorage.setItem('andy_last_seen_coins', cloudCoins);

                handleUrlParams(usedIds, cloudCoins);

            } catch (error) {
                console.log("ç½‘ç»œæ³¢åŠ¨");
                if(isManual) statusMsg.innerText = "è¿æ¥æœåŠ¡å™¨å¤±è´¥ (Steveè¿·è·¯äº†)";
            }
        }

        function showSuccessAnimation(amount) {
            statusMsg.innerText = `è·å¾—æˆå°±ï¼é’»çŸ³ +${amount}`;
            statusMsg.style.color = "#00aa00"; // MCç»¿è‰²

            totalDisplay.classList.remove('celebrate');
            void totalDisplay.offsetWidth; 
            totalDisplay.classList.add('celebrate');
            
            // åŠ¨ç”»ç»“æŸç§»é™¤è·³åŠ¨ï¼Œä¸ç„¶ä¸€ç›´è·³çœ¼æ™•
            setTimeout(() => totalDisplay.classList.remove('celebrate'), 2000);

            createConfetti();
        }

        function createConfetti() {
            // MC é£æ ¼çš„æ‰è½ç‰©ï¼šé’»çŸ³ã€ç»¿å®çŸ³ã€å‰‘ã€ç¨¿å­ã€TNTã€è‚‰
            const emojis = ['ğŸ’', 'ğŸŸ©', 'âš”ï¸', 'â›ï¸', 'ğŸ§¨', 'ğŸ–'];
            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.classList.add('confetti');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.style.left = Math.random() * 100 + 'vw';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.animationDuration = (Math.random() * 2 + 1.5) + 's'; 
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }
        }

        async function handleUrlParams(usedIds, currentCloudCoins) {
            const params = new URLSearchParams(window.location.search);
            const addAmount = parseInt(params.get('add'));
            const transId = params.get('id');

            if (addAmount && transId && !usedIds.includes(transId)) {
                statusMsg.innerText = "å‘ç°æ–°çš„å®è—ç®±...";
                let newCoins = currentCloudCoins + addAmount;
                usedIds.push(transId);
                
                await fetch(BASE_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ coins: newCoins, transactions: usedIds })
                });
                
                lastCoins = newCoins - addAmount; 
                checkCloud(); 
            }
        }

        function manualCheck() {
            checkCloud(true);
        }

        checkCloud();
        setInterval(() => checkCloud(), 60000); 

    </script>
</body>
</html>
