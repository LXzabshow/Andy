<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Andyçš„èƒŒåŒ…</title>
    <script type="text/javascript" src="https://cdn.goeasy.io/goeasy-2.11.13.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; user-select: none; }
        body { 
            background-color: #76b5fe; /* ç¨å¾®äº®ä¸€ç‚¹çš„å¤©ç©ºè“ */
            font-family: 'VT323', monospace; 
            text-align: center; 
            margin: 0; padding: 0;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨ï¼Œä¸ºäº†åº•éƒ¨åŠ¨ç”» */
            height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* ------------------- UI ç•Œé¢åŒº ------------------- */
        .ui-container {
            margin-top: 10vh;
            width: 90%;
            max-width: 400px;
            z-index: 100; /* ä¿è¯UIåœ¨è§’è‰²ä¸Šé¢ */
            position: relative;
        }

        .card { 
            background-color: #c6c6c6; 
            border: 4px solid #000;
            /* ç»å…¸çš„ MC è¾¹æ¡†å…‰å½±: ä¸Šå·¦äº®ï¼Œä¸‹å³æš— */
            box-shadow: inset 4px 4px #fff, inset -4px -4px #555; 
            padding: 20px; 
            position: relative; 
        }

        h2 { 
            color: #404040; margin: 0 0 15px 0; font-size: 32px; 
            text-shadow: 2px 2px #fff; letter-spacing: 2px; 
        }

        /* ç‰©å“æ æ ¼å­ */
        .slot {
            background: #8b8b8b;
            width: 120px; height: 120px;
            margin: 0 auto;
            border: 4px solid #373737;
            border-right-color: #fff; border-bottom-color: #fff;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .slot:hover { background: #9b9b9b; } /* ç®€å•çš„äº¤äº’æ„Ÿ */

        .coin-icon { font-size: 70px; filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.5)); z-index: 2;}

        .label { color: #404040; font-size: 20px; margin-top: 15px; font-weight: bold; text-shadow: 1px 1px #fff;}

        .total { 
            font-size: 80px; color: #fff; font-weight: bold; 
            text-shadow: 4px 4px 0px #333; margin: 5px 0; 
            font-family: 'VT323', sans-serif; 
        }

        /* ä¿¡å·ç¯ */
        .status-bar {
            background: #000; color: #fff;
            padding: 5px 10px; border-radius: 4px;
            font-size: 14px; display: inline-flex; align-items: center;
            margin-top: 10px; border: 2px solid #555;
        }
        .light { width: 8px; height: 8px; background: #e74c3c; margin-right: 8px; }
        .light.online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        .message { 
            color: #004400; margin-top: 10px; font-size: 18px; height: 24px; 
            text-shadow: 1px 1px #fff; font-weight: bold;
        }

        /* ------------------- åƒç´ ç”»ä¸åŠ¨ç”»åŒº ------------------- */
        
        /* åœ°é¢ */
        .ground {
            position: absolute; bottom: 0; width: 100%; height: 60px;
            background: #5D4037; /* æ³¥åœŸè‰² */
            border-top: 10px solid #4CAF50; /* è‰çš® */
            z-index: 10;
        }

        /* å²è’‚å¤« (çº¯CSSç”»çš„) */
        .steve {
            position: absolute; bottom: 45px; left: 10%;
            width: 40px; height: 90px;
            z-index: 5;
            animation: breathe 2s ease-in-out infinite;
        }
        .steve-head { width: 40px; height: 40px; background: #F8B090; position: absolute; top: 0; }
        .steve-hair { width: 40px; height: 10px; background: #452613; position: absolute; top: 0; }
        .steve-body { width: 40px; height: 30px; background: #00AAAA; position: absolute; top: 40px; }
        .steve-pants { width: 40px; height: 20px; background: #303090; position: absolute; top: 70px; }
        
        @keyframes breathe { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.02); } }

        /* è‹¦åŠ›æ€• (çº¯CSSç”»çš„) */
        .creeper {
            position: absolute; bottom: 45px; right: -50px;
            width: 30px; height: 80px;
            z-index: 6;
            animation: patrol 10s linear infinite;
        }
        .creeper-head { 
            width: 30px; height: 30px; background: #00AA00; position: absolute; top: 0; 
            border: 2px solid #005500; /* ç®€å•çš„åƒç´ æ‚è‰² */
        }
        /* è‹¦åŠ›æ€•çš„è„¸ */
        .face-eye-l { width: 6px; height: 6px; background: #000; position: absolute; top: 8px; left: 4px; }
        .face-eye-r { width: 6px; height: 6px; background: #000; position: absolute; top: 8px; right: 4px; }
        .face-mouth { width: 10px; height: 8px; background: #000; position: absolute; top: 18px; left: 10px; }
        .face-mouth-legs { width: 4px; height: 4px; background: #000; position: absolute; top: 24px; left: 10px; box-shadow: 6px 0 0 #000; }

        .creeper-body { width: 30px; height: 30px; background: #00AA00; position: absolute; top: 30px; }
        .creeper-legs { width: 30px; height: 20px; background: transparent; position: absolute; top: 60px; }
        .leg-f { width: 10px; height: 20px; background: #00AA00; position: absolute; left: 0; animation: walk 0.5s infinite alternate; }
        .leg-b { width: 10px; height: 20px; background: #00AA00; position: absolute; right: 0; animation: walk 0.5s infinite alternate-reverse; }

        @keyframes patrol {
            0% { right: -50px; transform: scaleX(1); }
            45% { right: 60%; transform: scaleX(1); }
            50% { right: 60%; transform: scaleX(-1); } /* è½¬èº« */
            95% { right: -50px; transform: scaleX(-1); }
            100% { right: -50px; transform: scaleX(1); }
        }
        @keyframes walk { from { transform: translateY(0); } to { transform: translateY(-3px); } }

        /* ç‰¹æ•ˆåŠ¨ç”» */
        .celebrate { animation: jump 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #55ff55 !important; }
        @keyframes jump { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        
        .confetti { position: fixed; top: -50px; z-index: 999; animation: fall linear forwards; pointer-events: none; font-size: 30px;}
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

    </style>
</head>
<body>

    <div class="ui-container">
        <div class="card">
            <h2>Andyçš„èƒŒåŒ…</h2>
            
            <div class="slot">
                <div class="coin-icon" id="icon">ğŸ’</div>
            </div>

            <div class="label">å½“å‰é’»çŸ³</div>
            <div id="totalDisplay" class="total">...</div>

            <div class="status-bar">
                <div id="light" class="light"></div> 
                <span id="connStatus">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</span>
            </div>
            
            <div id="statusMsg" class="message"></div>
        </div>
    </div>

    <div class="steve">
        <div class="steve-head"></div><div class="steve-hair"></div>
        <div class="steve-body"></div><div class="steve-pants"></div>
    </div>

    <div class="creeper">
        <div class="creeper-head">
            <div class="face-eye-l"></div><div class="face-eye-r"></div>
            <div class="face-mouth"></div><div class="face-mouth-legs"></div>
        </div>
        <div class="creeper-body"></div>
        <div class="creeper-legs">
            <div class="leg-f"></div><div class="leg-b"></div>
        </div>
    </div>

    <div class="ground"></div>

    <script>
        // ==========================================
        // âœ… ä½ çš„å¯†é’¥å·²å…¨éƒ¨å¡«å…¥ï¼Œç›´æ¥ä½¿ç”¨
        const BIN_ID = '695f1cbed0ea881f405c1aab'; 
        const API_KEY = '$2a$10$pSEOl/63AtvEMUqQopzGeuhVgcRcfXSz5L8lyQdZZHZM66zdYKI0O'; 
        const GOEASY_KEY = 'BC-493c3acc54de4c4bbe9fd9fdb8fcfb0c'; 
        // ==========================================

        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const totalDisplay = document.getElementById('totalDisplay');
        const statusMsg = document.getElementById('statusMsg');
        const light = document.getElementById('light');
        const connStatus = document.getElementById('connStatus');
        
        let lastCoins = null; 

        // 1. åˆå§‹åŒ– GoEasy
        const goEasy = GoEasy.getInstance({
            host: 'hangzhou.goeasy.io', 
            appkey: GOEASY_KEY,
            modules: ['pubsub']
        });

        // 2. è¿æ¥
        goEasy.connect({
            onSuccess: function () {
                light.classList.add('online');
                connStatus.innerText = "ä¿¡å·æ­£å¸¸";
                checkCloud(false);
            },
            onFailed: function (error) {
                connStatus.innerText = "ç¦»çº¿";
            }
        });

        // 3. ç›‘å¬
        goEasy.pubsub.subscribe({
            channel: "andy_channel",
            onMessage: function (message) {
                console.log("æ”¶åˆ°ä¿¡å·ï¼");
                checkCloud(true); 
            }
        });

        // 4. æŸ¥æ•°æ®
        async function checkCloud(forceAnim = false) {
            try {
                let response = await fetch(BASE_URL + '/latest', {
                    headers: { 'X-Master-Key': API_KEY }
                });
                let data = await response.json();
                let cloudCoins = data.record.coins || 0;
                let usedIds = data.record.transactions || [];

                if (lastCoins === null) {
                    lastCoins = parseInt(localStorage.getItem('andy_last_seen_coins')) || cloudCoins;
                }

                if (cloudCoins > lastCoins || (forceAnim && cloudCoins > lastCoins)) {
                    let diff = cloudCoins - lastCoins;
                    showSuccessAnimation(diff); 
                } else if (cloudCoins < lastCoins) {
                    statusMsg.innerText = `ä½¿ç”¨äº† ${lastCoins - cloudCoins} é¢—é’»çŸ³`;
                    statusMsg.style.color = "#8b0000";
                    setTimeout(() => statusMsg.innerText = "", 3000);
                }

                totalDisplay.innerText = cloudCoins;
                lastCoins = cloudCoins;
                localStorage.setItem('andy_last_seen_coins', cloudCoins);
                
                handleUrlParams(usedIds, cloudCoins);

            } catch (error) {
                console.log("è¯»å–å¤±è´¥");
            }
        }

        function showSuccessAnimation(amount) {
            statusMsg.innerText = `æˆå°±è¾¾æˆï¼+${amount}`;
            statusMsg.style.color = "#00aa00";
            
            totalDisplay.classList.remove('celebrate');
            void totalDisplay.offsetWidth; 
            totalDisplay.classList.add('celebrate');
            
            setTimeout(() => totalDisplay.classList.remove('celebrate'), 2000);
            createConfetti();
            setTimeout(() => statusMsg.innerText = "", 4000);
        }

        function createConfetti() {
            // æ‰è½ç‰©ï¼šé’»çŸ³ï¼Œç»¿å®çŸ³ï¼Œå‰‘ï¼ŒTNTï¼Œè‚‰
            const emojis = ['ğŸ’', 'ğŸŸ©', 'âš”ï¸', 'ğŸ§¨', 'ğŸ–'];
            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.classList.add('confetti');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.style.left = Math.random() * 100 + 'vw';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.animationDuration = (Math.random() * 2 + 1.5) + 's'; 
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }
        }

        async function handleUrlParams(usedIds, currentCloudCoins) {
            const params = new URLSearchParams(window.location.search);
            const addAmount = parseInt(params.get('add'));
            const transId = params.get('id');

            if (addAmount && transId && !usedIds.includes(transId)) {
                let newCoins = currentCloudCoins + addAmount;
                usedIds.push(transId);
                await fetch(BASE_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ coins: newCoins, transactions: usedIds })
                });
                lastCoins = newCoins - addAmount; 
                checkCloud(true); 
            }
        }
    </script>
</body>
</html>
