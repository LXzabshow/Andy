<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andyçš„ç§˜å¯†ä»“åº“</title>
    <style>
        body { font-family: 'Rounded Mplus 1c', sans-serif; background-color: #f0f4f8; text-align: center; padding: 20px; transition: background 0.5s; }
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 30px; }
        h2 { color: #2c3e50; margin: 0 0 10px 0; font-size: 24px; }
        .coin-icon { font-size: 60px; margin: 10px 0 20px 0; display: block; }
        .total { font-size: 60px; color: #ffb700; font-weight: bold; line-height: 1; transition: transform 0.2s;}
        .message { color: #666; margin-top: 20px; font-size: 16px; min-height: 24px;}
        .toast { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 100;}
        
        /* åŠ¨ç”»æ•ˆæœ */
        .pop { animation: pop-anim 0.3s ease; color: #e74c3c !important; }
        @keyframes pop-anim { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="toast" class="toast">æ•°æ®å·²æ›´æ–°</div>

    <div class="card">
        <h2>Andyçš„ç§˜å¯†ä»“åº“</h2>
        <div class="coin-icon">ğŸ’°</div>
        <div style="color:#888; font-size:14px;">å½“å‰ä½™é¢</div>
        <div id="totalDisplay" class="total">...</div>
        <div id="statusMsg" class="message"></div>
    </div>

    <script>
        // ==========================================
        // ã€è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ JsonBin ä¿¡æ¯ã€‘
        const BIN_ID = '695f1cbed0ea881f405c1aab'; 
        const API_KEY = '$2a$10$pSEOl/63AtvEMUqQopzGeuhVgcRcfXSz5L8lyQdZZHZM66zdYKI0O'; 
        // ==========================================

        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const totalDisplay = document.getElementById('totalDisplay');
        const statusMsg = document.getElementById('statusMsg');
        
        // è®°å½•æœ¬åœ°å½“å‰çš„å¸æ•°ï¼Œç”¨äºå¯¹æ¯”
        let localCoins = null; 
        let isFirstLoad = true;

        // æ ¸å¿ƒå‡½æ•°ï¼šè¯»å–äº‘ç«¯
        async function checkCloud() {
            try {
                let response = await fetch(BASE_URL + '/latest', {
                    headers: { 'X-Master-Key': API_KEY }
                });
                let data = await response.json();
                let cloudCoins = data.record.coins || 0;
                let usedIds = data.record.transactions || [];

                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œæˆ–è€…æ•°æ®å‘ç”Ÿäº†å˜åŒ–
                if (localCoins !== null && cloudCoins !== localCoins) {
                    let diff = cloudCoins - localCoins;
                    showChange(diff); // æ’­æ”¾åŠ¨ç”»
                }

                localCoins = cloudCoins;
                totalDisplay.innerText = localCoins;

                // åªæœ‰ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ‰æ£€æŸ¥URLå‚æ•°æ˜¯å¦è¦åŠ å¸
                if (isFirstLoad) {
                    isFirstLoad = false;
                    handleUrlParams(usedIds, cloudCoins);
                }

            } catch (error) {
                console.log("åŒæ­¥ä¸­..."); // é™é»˜å¤±è´¥ï¼Œä¸æ‰“æ‰°ç”¨æˆ·
            }
        }

        // å¤„ç†URLå‚æ•°åŠ å¸é€»è¾‘ (å’Œä¹‹å‰ä¸€æ ·)
        async function handleUrlParams(usedIds, currentCloudCoins) {
            const params = new URLSearchParams(window.location.search);
            const addAmount = parseInt(params.get('add'));
            const transId = params.get('id');

            if (addAmount && transId) {
                if (!usedIds.includes(transId)) {
                    statusMsg.innerText = "æ­£åœ¨å­˜å…¥...";
                    let newCoins = currentCloudCoins + addAmount;
                    usedIds.push(transId);
                    
                    await fetch(BASE_URL, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                        body: JSON.stringify({ coins: newCoins, transactions: usedIds })
                    });
                    
                    statusMsg.innerText = `æˆåŠŸå­˜å…¥ ${addAmount} å¸ï¼`;
                    // å¼ºåˆ¶ç«‹åˆ»åˆ·æ–°ä¸€æ¬¡æ˜¾ç¤º
                    localCoins = newCoins;
                    totalDisplay.innerText = newCoins;
                    showChange(addAmount);
                } else {
                    statusMsg.innerText = "âš ï¸ è¿™ä¸ªå¥–åŠ±å·²ç»é¢†è¿‡å•¦";
                }
            }
        }

        // åŠ¨ç”»æ•ˆæœ
        function showChange(diff) {
            const toast = document.getElementById('toast');
            totalDisplay.classList.remove('pop');
            void totalDisplay.offsetWidth; // è§¦å‘é‡ç»˜
            totalDisplay.classList.add('pop');
            
            if(diff > 0) {
                toast.innerText = `å“‡ï¼è¿œç¨‹å…¥è´¦ +${diff} å¸ï¼ğŸ‰`;
                toast.style.background = "#2ecc71";
            } else {
                toast.innerText = `æ¶ˆè´¹æ‰£é™¤ ${diff} å¸`;
                toast.style.background = "#e74c3c";
            }
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        // å¯åŠ¨ç¨‹åºï¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ¯5ç§’æ‰§è¡Œä¸€æ¬¡
        checkCloud();
        setInterval(checkCloud, 5000); // 5ç§’è½®è¯¢ä¸€æ¬¡

    </script>
</body>
</html>
