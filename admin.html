<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶é•¿æ§åˆ¶å° - æ…¢é€Ÿç½‘ç»œç‰ˆ</title>
    <script src="https://cdn.goeasy.io/goeasy-2.14.17.min.js"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; background: #222; color: #eee; text-align: center; max-width: 500px; margin: 0 auto;}
        .box { background: #333; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .big-num { font-size: 60px; font-weight: bold; margin: 20px 0; color: #ffb700; text-shadow: 0 0 10px rgba(255, 183, 0, 0.3);}
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;}
        button { padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.1s;}
        button:active { transform: scale(0.96); }
        .btn-add { background: #27ae60; color: white; }
        .btn-sub { background: #c0392b; color: white; }
        input { padding: 12px; border-radius: 5px; border: none; width: 60%; text-align: center; background: #444; color: white; font-size: 16px;}
        .manual-group { background: #444; padding: 15px; border-radius: 8px; margin-top: 20px;}
        #log { color: #888; font-size: 12px; margin-top: 15px; min-height: 20px; line-height: 1.5; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="box">
        <h3>ğŸ‘¨â€ğŸ’» Andyçš„ä¸–ç•Œ - æ§åˆ¶å°</h3>
        <div id="currentCoins" class="big-num">...</div>

        <div class="grid">
            <button class="btn-add" onclick="modifyCoins(10)">+10 å¥–åŠ±</button>
            <button class="btn-add" onclick="modifyCoins(50)">+50 å¤§å¥–</button>
            <button class="btn-sub" onclick="modifyCoins(-10)">-10 æ‰£é™¤</button>
            <button class="btn-sub" onclick="modifyCoins(-50)">-50 å…‘æ¢</button>
        </div>

        <div class="manual-group">
            <input type="number" id="manualInput" placeholder="è¾“å…¥è‡ªå®šä¹‰æ•°å­—">
            <br><br>
            <button class="btn-add" style="width: 45%;" onclick="manualMod(1)">å¢åŠ </button>
            <button class="btn-sub" style="width: 45%;" onclick="manualMod(-1)">æ‰£é™¤</button>
        </div>
        
        <div id="log">ç­‰å¾…ç½‘ç»œèµ„æº...</div>
    </div>

    <script>
        const BIN_ID = '695f1cbed0ea881f405c1aab'; 
        const API_KEY = '$2a$10$pSEOl/63AtvEMUqQopzGeuhVgcRcfXSz5L8lyQdZZHZM66zdYKI0O'; 
        const GOEASY_KEY = 'BC-493c3acc54de4c4bbe9fd9fdb8fcfb0c'; 
        const GOEASY_HOST = 'hangzhou.goeasy.io';

        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const display = document.getElementById('currentCoins');
        const log = document.getElementById('log');
        const PASS = "8888"; 

        let goEasy = null;
        let checkCount = 0;

        window.onload = function() {
            if(prompt("è¯·è¾“å…¥å®¶é•¿å¯†ç ") !== PASS) { 
                document.body.innerHTML = "<h3 style='color:red'>å¯†ç é”™è¯¯</h3>"; return;
            }
            
            // 1. å…ˆè¯»å–é‡‘å¸ (è¿™ä¸ªä¸ä¾èµ– GoEasy)
            getCoins();
            log.innerText = "â³ æ­£åœ¨åŠ è½½é€šä¿¡æ¨¡å—...";

            // 2. å¯åŠ¨ã€æ…¢é€Ÿè½®è¯¢æœºåˆ¶ã€‘
            // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤šæ£€æŸ¥ 10 æ¬¡ (10ç§’)
            let checkTimer = setInterval(() => {
                checkCount++;
                
                if (typeof GoEasy !== 'undefined') {
                    // æˆåŠŸåŠ è½½ï¼åœæ­¢æ£€æŸ¥ï¼Œå¼€å§‹åˆå§‹åŒ–
                    clearInterval(checkTimer);
                    initGoEasy();
                } else {
                    console.log("ç­‰å¾… GoEasy åŠ è½½... " + checkCount);
                    if (checkCount >= 10) {
                        clearInterval(checkTimer);
                        log.innerText = "âŒ è¶…æ—¶ï¼šé€šä¿¡æ¨¡å—åŠ è½½å¤±è´¥ã€‚\nè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚";
                    }
                }
            }, 1000); 
        };

        function initGoEasy() {
            try {
                goEasy = GoEasy.getInstance({
                    host: GOEASY_HOST, 
                    appkey: GOEASY_KEY,
                    modules: ['pubsub']
                });
                goEasy.connect({
                    onSuccess: () => { log.innerText = "âœ… ç³»ç»Ÿè¿æ¥æ­£å¸¸"; },
                    onFailed: (err) => { log.innerText = "âŒ ä¿¡å·è¿æ¥å¤±è´¥: " + err.content; }
                });
            } catch (e) {
                log.innerText = "âŒ åˆå§‹åŒ–å¼‚å¸¸: " + e.message;
            }
        }

        async function getCoins() {
            try {
                let res = await fetch(BASE_URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
                let data = await res.json();
                display.innerText = data.record.coins;
                return data.record;
            } catch (e) { log.innerText = "è¯»å–æ•°æ®å¤±è´¥"; }
        }

        async function modifyCoins(amount) {
            log.innerText = "æ­£åœ¨å†™å…¥äº‘ç«¯...";
            let currentRecord = null;
            try {
                let record = await getCoins();
                let newCoins = record.coins + amount;
                await fetch(BASE_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ coins: newCoins, transactions: record.transactions })
                });
                display.innerText = newCoins;
                currentRecord = newCoins;
                log.innerText = "âœ… é‡‘å¸ä¿å­˜æˆåŠŸï¼";
            } catch (e) { 
                log.innerText = "âŒ ä¸¥é‡é”™è¯¯ï¼šé‡‘å¸ä¿å­˜å¤±è´¥ï¼"; return;
            }

            // å°è¯•å‘é€é€šçŸ¥
            if(goEasy) {
                log.innerText += "\næ­£åœ¨å‘¼å«å­©å­ç«¯...";
                try {
                    goEasy.publish({
                        channel: "andy_channel", message: "update",
                        onSuccess: () => log.innerText = `âœ… å…¨éƒ¨æˆåŠŸï¼ä½™é¢: ${currentRecord}`,
                        onFailed: (err) => log.innerText = `âš ï¸ é‡‘å¸å­˜äº†ï¼Œä½†é€šçŸ¥å¤±è´¥: ${err.content}`
                    });
                } catch(e) { log.innerText += "\nâš ï¸ å‘é€å‡ºé”™"; }
            } else {
                log.innerText += "\nâš ï¸ ä¿¡å·æœªè¿æ¥ (ä¸å½±å“é‡‘å¸ä¿å­˜)"; 
            }
        }

        function manualMod(sign) {
            let val = parseInt(document.getElementById('manualInput').value);
            if(val) modifyCoins(val * sign);
        }
    </script>
</body>
</html>
