<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Andyçš„å†’é™©èƒŒåŒ…</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼ŒèŠ‚çœç¯‡å¹…ï¼Œç›´æ¥å¤åˆ¶ä¹‹å‰çš„å³å¯ */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: #76b5fe; font-family: 'VT323', monospace; text-align: center; margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; align-items: center; transition: background-color 2s ease; }
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(white 1px, transparent 1px); background-size: 50px 50px, 100px 100px; background-position: 0 0, 25px 25px; opacity: 0; transition: opacity 2s; z-index: 0; pointer-events: none; }
        body.night .stars { opacity: 0.5; } body.night { background-color: #1a0b2e; }
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .mc-btn { background: #727272; border: 4px solid #fff; padding: 15px 30px; font-size: 24px; color: white; font-family: 'VT323', monospace; cursor: pointer; box-shadow: inset 4px 4px #aaa, inset -4px -4px #444; text-transform: uppercase; margin-top: 20px; }
        .mc-btn:active { background: #555; border-color: #aaa; transform: scale(0.95); }
        .ui-container { margin-top: 8vh; width: 90%; max-width: 400px; z-index: 100; position: relative; }
        .card { background-color: #c6c6c6; border: 4px solid #000; box-shadow: inset 4px 4px #fff, inset -4px -4px #555; padding: 20px; position: relative; }
        h2 { color: #404040; margin: 0 0 5px 0; font-size: 32px; text-shadow: 2px 2px #fff; letter-spacing: 2px; }
        .rank-badge { background: #333; color: #f1c40f; padding: 2px 10px; border: 2px solid #fff; display: inline-block; margin-bottom: 15px; font-size: 18px; border-radius: 4px; box-shadow: 2px 2px 0 rgba(0,0,0,0.3); }
        .slot { background: #8b8b8b; width: 120px; height: 120px; margin: 0 auto; border: 4px solid #373737; border-right-color: #fff; border-bottom-color: #fff; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .slot:active .coin-icon { transform: scale(0.8); }
        .coin-icon { font-size: 70px; filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.5)); z-index: 2; transition: transform 0.1s;}
        .label { color: #404040; font-size: 20px; margin-top: 15px; font-weight: bold; text-shadow: 1px 1px #fff;}
        .total { font-size: 80px; color: #fff; font-weight: bold; text-shadow: 4px 4px 0px #333; margin: 5px 0; line-height: 1; }
        .status-bar { background: #000; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 14px; display: inline-flex; align-items: center; margin-top: 10px; border: 2px solid #555; }
        .light { width: 8px; height: 8px; background: #e74c3c; margin-right: 8px; }
        .light.online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .message { color: #004400; margin-top: 10px; font-size: 18px; height: 24px; text-shadow: 1px 1px #fff; font-weight: bold;}
        .mute-btn { position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; color: #555; }
        .ground { position: absolute; bottom: 0; width: 100%; height: 60px; background: #5D4037; border-top: 10px solid #4CAF50; z-index: 10; }
        .steve { position: absolute; bottom: 45px; left: 10%; width: 40px; height: 90px; z-index: 5; animation: breathe 2s ease-in-out infinite; }
        .steve-head { width: 40px; height: 40px; background: #F8B090; position: absolute; top: 0; }
        .steve-hair { width: 40px; height: 10px; background: #452613; position: absolute; top: 0; }
        .steve-body { width: 40px; height: 30px; background: #00AAAA; position: absolute; top: 40px; }
        .steve-pants { width: 40px; height: 20px; background: #303090; position: absolute; top: 70px; }
        @keyframes breathe { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.02); } }
        .creeper { position: absolute; bottom: 45px; right: -50px; width: 30px; height: 80px; z-index: 6; animation: patrol 15s linear infinite; }
        .creeper-head { width: 30px; height: 30px; background: #00AA00; position: absolute; top: 0; border: 2px solid #005500; }
        .face-eye-l { width: 6px; height: 6px; background: #000; position: absolute; top: 8px; left: 4px; }
        .face-eye-r { width: 6px; height: 6px; background: #000; position: absolute; top: 8px; right: 4px; }
        .face-mouth { width: 10px; height: 8px; background: #000; position: absolute; top: 18px; left: 10px; }
        .face-mouth-legs { width: 4px; height: 4px; background: #000; position: absolute; top: 24px; left: 10px; box-shadow: 6px 0 0 #000; }
        .creeper-body { width: 30px; height: 30px; background: #00AA00; position: absolute; top: 30px; }
        .creeper-legs { width: 30px; height: 20px; background: transparent; position: absolute; top: 60px; }
        .leg-f { width: 10px; height: 20px; background: #00AA00; position: absolute; left: 0; animation: walk 0.5s infinite alternate; }
        .leg-b { width: 10px; height: 20px; background: #00AA00; position: absolute; right: 0; animation: walk 0.5s infinite alternate-reverse; }
        @keyframes patrol { 0% { right: -50px; transform: scaleX(1); } 45% { right: 60%; transform: scaleX(1); } 50% { right: 60%; transform: scaleX(-1); } 95% { right: -50px; transform: scaleX(-1); } 100% { right: -50px; transform: scaleX(1); } }
        @keyframes walk { from { transform: translateY(0); } to { transform: translateY(-3px); } }
        .celebrate { animation: jump 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #f1c40f !important; text-shadow: 4px 4px 0 #b7950b !important; }
        @keyframes jump { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
        .confetti { position: fixed; top: -50px; z-index: 999; animation: fall linear forwards; pointer-events: none; font-size: 30px;}
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body>
    <div class="stars"></div>

    <div id="start-overlay">
        <h1 style="text-shadow: 4px 4px #000; font-size: 40px; margin-bottom:10px;">Andyçš„ä¸–ç•Œ</h1>
        <p style="opacity: 0.8; font-size: 16px;">Server: Online | Ping: 18ms</p>
        <button class="mc-btn" onclick="document.getElementById('start-overlay').style.display='none'; startGame()">è¿›å…¥æ¸¸æˆ</button>
    </div>

    <audio id="bgm" loop><source src="https://raw.githubusercontent.com/kurisubrooks/minecraft-sounds/master/sounds/music/game/calm1.ogg" type="audio/ogg"></audio>
    <audio id="sfx-levelup"><source src="https://raw.githubusercontent.com/kurisubrooks/minecraft-sounds/master/sounds/random/levelup.ogg" type="audio/ogg"></audio>
    <audio id="sfx-damage"><source src="https://raw.githubusercontent.com/kurisubrooks/minecraft-sounds/master/sounds/damage/hit1.ogg" type="audio/ogg"></audio>
    <audio id="sfx-click"><source src="https://raw.githubusercontent.com/kurisubrooks/minecraft-sounds/master/sounds/random/click.ogg" type="audio/ogg"></audio>

    <div class="ui-container">
        <div class="card">
            <div class="mute-btn" onclick="toggleMute()">ğŸ”Š</div>
            <h2>Andyçš„èƒŒåŒ…</h2>
            <div id="rankBadge" class="rank-badge">åŠ è½½ä¸­...</div>
            <div class="slot" onclick="clickCoin()"><div class="coin-icon" id="icon">ğŸª™</div></div>
            <div class="label">å½“å‰æ‹¥æœ‰å¸</div>
            <div id="totalDisplay" class="total">...</div>
            <div class="status-bar"><div id="light" class="light"></div><span id="connStatus">æ­£åœ¨ç”Ÿæˆåœ°å½¢...</span></div>
            <div id="statusMsg" class="message"></div>
        </div>
    </div>

    <div class="steve"><div class="steve-head"></div><div class="steve-hair"></div><div class="steve-body"></div><div class="steve-pants"></div></div>
    <div class="creeper"><div class="creeper-head"><div class="face-eye-l"></div><div class="face-eye-r"></div><div class="face-mouth"></div><div class="face-mouth-legs"></div></div><div class="creeper-body"></div><div class="creeper-legs"><div class="leg-f"></div><div class="leg-b"></div></div></div>
    <div class="ground"></div>

    <script type="text/javascript" src="https://cdn.goeasy.io/goeasy-2.11.13.min.js"></script>

    <script>
        window.onerror = function(msg) { alert("é”™è¯¯: " + msg); return true; };

        const BIN_ID = '695f1cbed0ea881f405c1aab'; 
        const API_KEY = '$2a$10$pSEOl/63AtvEMUqQopzGeuhVgcRcfXSz5L8lyQdZZHZM66zdYKI0O'; 
        const GOEASY_KEY = 'BC-493c3acc54de4c4bbe9fd9fdb8fcfb0c'; 
        
        // âœ… ç¡®è®¤æ— è¯¯ï¼šä½¿ç”¨æ­å·èŠ‚ç‚¹
        const GOEASY_HOST = 'hangzhou.goeasy.io';

        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const totalDisplay = document.getElementById('totalDisplay');
        const statusMsg = document.getElementById('statusMsg');
        const light = document.getElementById('light');
        const connStatus = document.getElementById('connStatus');
        const rankBadge = document.getElementById('rankBadge');
        
        const bgm = document.getElementById('bgm');
        const sfxLevelUp = document.getElementById('sfx-levelup');
        const sfxDamage = document.getElementById('sfx-damage');
        const sfxClick = document.getElementById('sfx-click');
        let isMuted = false;
        let lastCoins = null; 

        const RANKS = [
            { limit: 0, title: "ğŸªµ æ–°æ‰‹ä¼æœ¨å·¥" },
            { limit: 50, title: "ğŸª¨ ç†Ÿç»ƒé‡‡çŸ³åŒ " },
            { limit: 150, title: "âš”ï¸ é“ç”²å«å£«" },
            { limit: 300, title: "ğŸ† é»„é‡‘é¢†ä¸»" },
            { limit: 500, title: "ğŸ’ é’»çŸ³å¤§ç¥" },
            { limit: 1000, title: "ğŸ² æœ«å½±å± é¾™è€…" }
        ];

        function startGame() {
            try {
                checkDayNight(); 
                if(bgm) { bgm.volume = 0.4; bgm.play().catch(e => {}); }
                checkCloud(false);
                initGoEasy();
            } catch(e) {}
        }

        function checkDayNight() {
            const hour = new Date().getHours();
            if (hour >= 18 || hour < 6) document.body.classList.add('night');
            else document.body.classList.remove('night');
        }

        function updateRank(coins) {
            let currentTitle = RANKS[0].title;
            for(let rank of RANKS) {
                if(coins >= rank.limit) currentTitle = rank.title;
            }
            rankBadge.innerText = currentTitle;
        }

        function clickCoin() {
            if(!isMuted && sfxClick) { sfxClick.currentTime = 0; sfxClick.play().catch(e=>{}); }
            if(navigator.vibrate) navigator.vibrate(20);
        }

        function toggleMute() {
            isMuted = !isMuted;
            if(isMuted) {
                if(bgm) bgm.pause();
                document.querySelector('.mute-btn').innerText = 'ğŸ”‡';
            } else {
                if(bgm) bgm.play();
                document.querySelector('.mute-btn').innerText = 'ğŸ”Š';
            }
        }

        function playSound(type) {
            if(isMuted) return;
            try {
                if(type === 'up' && sfxLevelUp) { sfxLevelUp.currentTime = 0; sfxLevelUp.play(); } 
                else if (type === 'down' && sfxDamage) { sfxDamage.currentTime = 0; sfxDamage.play(); }
            } catch(e){}
        }

        async function checkCloud(forceAnim = false) {
            if(connStatus.innerText.includes("ç”Ÿæˆ")) connStatus.innerText = "æ­£åœ¨è¯»å–å­˜æ¡£...";
            
            try {
                let response = await fetch(BASE_URL + '/latest', {
                    headers: { 'X-Master-Key': API_KEY }
                });
                let data = await response.json();
                let cloudCoins = data.record.coins || 0;
                let usedIds = data.record.transactions || [];

                if (lastCoins === null) {
                    lastCoins = parseInt(localStorage.getItem('andy_last_seen_coins')) || cloudCoins;
                }

                if (cloudCoins > lastCoins || (forceAnim && cloudCoins > lastCoins)) {
                    let diff = cloudCoins - lastCoins;
                    showSuccessAnimation(diff); 
                } else if (cloudCoins < lastCoins) {
                    statusMsg.innerText = `äº¤æ˜“æˆåŠŸ! æ”¯ä»˜ ${lastCoins - cloudCoins} å¸`;
                    statusMsg.style.color = "#8b0000";
                    playSound('down'); 
                    setTimeout(() => statusMsg.innerText = "", 3000);
                }

                totalDisplay.innerText = cloudCoins;
                lastCoins = cloudCoins;
                localStorage.setItem('andy_last_seen_coins', cloudCoins);
                updateRank(cloudCoins);

                if(light.classList.contains('online')) connStatus.innerText = "æœåŠ¡å™¨åœ¨çº¿";
                else connStatus.innerText = "èƒŒåŒ…æ•´ç†å®Œæ¯•";

                handleUrlParams(usedIds, cloudCoins);
            } catch (error) {
                connStatus.innerText = "ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥";
                statusMsg.innerText = "è¯»å–æ•°æ®å¤±è´¥...";
                statusMsg.style.color = "red";
            }
        }

        function initGoEasy() {
            if(typeof GoEasy === 'undefined') return;
            try {
                const goEasy = GoEasy.getInstance({
                    host: GOEASY_HOST,  // âœ… ä½¿ç”¨æ­å·èŠ‚ç‚¹
                    appkey: GOEASY_KEY,
                    modules: ['pubsub']
                });

                goEasy.connect({
                    onSuccess: function () {
                        light.classList.add('online');
                        if(!connStatus.innerText.includes("æ–­å¼€")) connStatus.innerText = "æœåŠ¡å™¨åœ¨çº¿";
                    },
                    onFailed: function (error) { connStatus.innerText = "ç¦»çº¿æ¨¡å¼"; }
                });

                goEasy.pubsub.subscribe({
                    channel: "andy_channel",
                    onMessage: function (message) { checkCloud(true); }
                });
            } catch(e) {}
        }

        function showSuccessAnimation(amount) {
            statusMsg.innerText = `è·å¾—æˆ˜åˆ©å“ï¼å¸ +${amount}`;
            statusMsg.style.color = "#00aa00";
            playSound('up');
            totalDisplay.classList.remove('celebrate');
            void totalDisplay.offsetWidth; 
            totalDisplay.classList.add('celebrate');
            setTimeout(() => totalDisplay.classList.remove('celebrate'), 2000);
            createConfetti();
            setTimeout(() => statusMsg.innerText = "", 4000);
        }

        function createConfetti() {
            const emojis = ['ğŸª™', 'ğŸª™', 'ğŸŸ©', 'âš”ï¸', 'ğŸ§¨', 'ğŸ–'];
            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.classList.add('confetti');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.style.left = Math.random() * 100 + 'vw';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.animationDuration = (Math.random() * 2 + 1.5) + 's'; 
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 4000);
            }
        }

        async function handleUrlParams(usedIds, currentCloudCoins) {
            const params = new URLSearchParams(window.location.search);
            const addAmount = parseInt(params.get('add'));
            const transId = params.get('id');

            if (addAmount && transId && !usedIds.includes(transId)) {
                statusMsg.innerText = "æ­£åœ¨æ”¾å…¥æœ«å½±ç®±...";
                let newCoins = currentCloudCoins + addAmount;
                usedIds.push(transId);
                await fetch(BASE_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ coins: newCoins, transactions: usedIds })
                });
                lastCoins = newCoins - addAmount; 
                checkCloud(true); 
            }
        }
    </script>
</body>
</html>
