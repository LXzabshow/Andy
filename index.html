<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andyçš„ç§˜å¯†ä»“åº“</title>
    <style>
        body { font-family: 'Rounded Mplus 1c', sans-serif; background-color: #f0f4f8; text-align: center; padding: 20px; overflow-x: hidden; }
        .card { background: white; border-radius: 20px; padding: 40px 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 30px; position: relative; z-index: 10; }
        
        h2 { color: #2c3e50; margin: 0 0 10px 0; font-size: 24px; }
        .coin-icon { font-size: 80px; margin: 10px 0; display: block; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); transition: transform 0.3s; }
        
        .label { color: #888; font-size: 14px; margin-bottom: 5px; }
        .total { font-size: 70px; color: #ffb700; font-weight: bold; line-height: 1; text-shadow: 2px 2px 0px #ffeaa7; transition: all 0.5s; }
        
        .btn-refresh { margin-top: 30px; background: #3498db; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-size: 14px; cursor: pointer; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); transition: transform 0.1s; }
        .btn-refresh:active { transform: scale(0.95); }

        .message { color: #666; margin-top: 15px; font-size: 14px; min-height: 20px; }

        /* åŠ¨ç”»å…³é”®å¸§ */
        .celebrate { animation: jump 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); color: #e67e22; }
        @keyframes jump { 0% { transform: scale(1); } 50% { transform: scale(1.5) rotate(-10deg); } 100% { transform: scale(1) rotate(0); } }

        /* é‡‘å¸é›¨ç²’å­æ ·å¼ */
        .confetti { position: fixed; top: -50px; z-index: 99; animation: fall linear forwards; pointer-events: none; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>

    <div class="card">
        <h2>Andyçš„ç§˜å¯†ä»“åº“</h2>
        <div class="coin-icon" id="icon">ğŸ’°</div>
        <div class="label">å½“å‰ç§¯è“„</div>
        
        <div id="totalDisplay" class="total">...</div>
        
        <div id="statusMsg" class="message">è¿æ¥ä¸­...</div>

        <button class="btn-refresh" onclick="manualCheck()">ğŸ”„ åˆ·æ–°çœ‹çœ‹æœ‰æ²¡åˆ°è´¦</button>
    </div>

    <script>
        // ==========================================
        // å·²è‡ªåŠ¨å¡«å…¥æ‚¨çš„å¯†é’¥
        const BIN_ID = '695f1cbed0ea881f405c1aab'; 
        const API_KEY = '$2a$10$pSEOl/63AtvEMUqQopzGeuhVgcRcfXSz5L8lyQdZZHZM66zdYKI0O'; 
        // ==========================================

        const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const totalDisplay = document.getElementById('totalDisplay');
        const statusMsg = document.getElementById('statusMsg');
        const coinIcon = document.getElementById('icon');
        
        let lastCoins = null; 
        
        async function checkCloud(isManual = false) {
            if(isManual) statusMsg.innerText = "æ­£åœ¨æŸ¥è¯¢...";
            
            try {
                let response = await fetch(BASE_URL + '/latest', {
                    headers: { 'X-Master-Key': API_KEY }
                });
                let data = await response.json();
                let cloudCoins = data.record.coins || 0;
                let usedIds = data.record.transactions || [];

                if (lastCoins === null) {
                    lastCoins = parseInt(localStorage.getItem('andy_last_seen_coins')) || cloudCoins;
                }

                if (cloudCoins > lastCoins) {
                    let diff = cloudCoins - lastCoins;
                    showSuccessAnimation(diff); 
                } else if (cloudCoins < lastCoins) {
                    statusMsg.innerText = `æ‰£é™¤äº† ${lastCoins - cloudCoins} å¸`;
                } else {
                    if(isManual) statusMsg.innerText = "æš‚æ—¶æ²¡æœ‰æ–°å¥–åŠ±å“¦ ~";
                }

                totalDisplay.innerText = cloudCoins;
                lastCoins = cloudCoins;
                localStorage.setItem('andy_last_seen_coins', cloudCoins);

                handleUrlParams(usedIds, cloudCoins);

            } catch (error) {
                console.log("ç½‘ç»œæ³¢åŠ¨");
                if(isManual) statusMsg.innerText = "ç½‘ç»œä¸å¤ªå¥½ï¼Œç¨åå†è¯•";
            }
        }

        function showSuccessAnimation(amount) {
            statusMsg.innerText = `ğŸ‰ å“‡ï¼åˆšåˆšåˆ°è´¦ +${amount} å¸ï¼`;
            statusMsg.style.color = "#27ae60";
            statusMsg.style.fontWeight = "bold";

            totalDisplay.classList.remove('celebrate');
            void totalDisplay.offsetWidth; 
            totalDisplay.classList.add('celebrate');
            
            coinIcon.style.transform = "scale(1.2) rotate(20deg)";
            setTimeout(() => coinIcon.style.transform = "scale(1) rotate(0)", 500);

            createConfetti();
        }

        function createConfetti() {
            const emojis = ['ğŸ’°', 'ğŸª™', 'âœ¨', 'ğŸ‰', 'ğŸ’'];
            for (let i = 0; i < 50; i++) {
                const el = document.createElement('div');
                el.classList.add('confetti');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.style.left = Math.random() * 100 + 'vw';
                el.style.fontSize = (Math.random() * 20 + 20) + 'px';
                el.style.animationDuration = (Math.random() * 3 + 2) + 's'; 
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 5000);
            }
        }

        async function handleUrlParams(usedIds, currentCloudCoins) {
            const params = new URLSearchParams(window.location.search);
            const addAmount = parseInt(params.get('add'));
            const transId = params.get('id');

            if (addAmount && transId && !usedIds.includes(transId)) {
                statusMsg.innerText = "å‘ç°æ–°å¥–åŠ±ï¼Œæ­£åœ¨å…¥åº“...";
                let newCoins = currentCloudCoins + addAmount;
                usedIds.push(transId);
                
                await fetch(BASE_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ coins: newCoins, transactions: usedIds })
                });
                
                lastCoins = newCoins - addAmount; 
                checkCloud(); 
            }
        }

        function manualCheck() {
            checkCloud(true);
        }

        checkCloud();
        // 1åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼Œè¶…çº§çœæµ
        setInterval(() => checkCloud(), 60000); 

    </script>
</body>
</html>
